name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.5.0). Leave empty to auto-bump patch version.'
        required: false
        type: string
      bump:
        description: 'Version bump type (only used if version is empty)'
        required: false
        type: choice
        default: 'patch'
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  create-tag:
    runs-on: ubuntu-24.04
    outputs:
      tag: ${{ steps.compute-tag.outputs.tag }}
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
      - id: compute-tag
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            TAG="v${{ inputs.version }}"
          else
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            VERSION=${LATEST_TAG#v}

            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

            case "${{ inputs.bump }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            TAG="v${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Computed tag: $TAG"
      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.compute-tag.outputs.tag }} -m "Release ${{ steps.compute-tag.outputs.tag }}"
          git push origin ${{ steps.compute-tag.outputs.tag }}

  goreleaser:
    needs: create-tag
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          ref: ${{ needs.create-tag.outputs.tag }}
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
      - uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
